name: Keep Supabase Alive

on:
  schedule:
    # Run every 3 days at 2:00 AM UTC
    # Cron format: minute hour day month weekday
    - cron: '0 2 */3 * *'
  
  # Allow manual trigger from GitHub UI
  workflow_dispatch:

jobs:
  ping-supabase:
    runs-on: ubuntu-latest
    
    steps:
      - name: Ping Supabase Database
        run: |
          echo "ğŸ”„ Pinging Supabase database..."
          
          # Call the keep_alive function
          response=$(curl -s -w "\n%{http_code}" \
            -X POST \
            'https://${{ secrets.SUPABASE_PROJECT_REF }}.supabase.co/rest/v1/rpc/keep_alive' \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Content-Type: application/json")
          
          # Extract HTTP code and body
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          echo "ğŸ“Š Response body: $body"
          echo "ğŸ“¡ HTTP status code: $http_code"
          
          # Check if successful
          if [ "$http_code" -eq 200 ] || [ "$http_code" -eq 204 ]; then
            echo "âœ… Supabase pinged successfully!"
            
            # Extract ping count if available
            ping_count=$(echo "$body" | grep -o '"total_pings":[0-9]*' | grep -o '[0-9]*' || echo "N/A")
            echo "ğŸ“ˆ Total pings: $ping_count"
            
            exit 0
          else
            echo "âŒ Supabase ping failed with status $http_code"
            exit 1
          fi
      
      - name: Verify Database Connection
        if: success()
        run: |
          echo "ğŸ” Verifying database is responsive..."
          
          # Query the keep_alive table to double-check
          response=$(curl -s -w "\n%{http_code}" \
            'https://${{ secrets.SUPABASE_PROJECT_REF }}.supabase.co/rest/v1/_keep_alive?select=*' \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          if [ "$http_code" -eq 200 ]; then
            echo "âœ… Database is alive and responding!"
            echo "ğŸ“Š Last ping data: $body"
          else
            echo "âš ï¸ Warning: Database query failed with status $http_code"
          fi
      
      - name: Summary
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‹ Keep-Alive Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â° Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸ—„ï¸  Services pinged:"
          echo "   â€¢ Supabase Database"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
